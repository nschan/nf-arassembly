/* ----------------------------------------------------
 * Nextflow config file for the BioHPC Genomics Cluster
 * ----------------------------------------------------
 */

env {
  SLURM_CLUSTERS='biohpc_gen'
}

process {
  executor = 'slurm'
  queue = { task.memory <= 1536.GB ? (task.time > 2.d || task.memory > 384.GB ? 'biohpc_gen_production' : 'biohpc_gen_normal') : 'biohpc_gen_highmem' }
}

charliecloud {
  enabled = true
}

process {

  withName: COLLECT_READS {
	  cpus = {4 * task.attempt }
	  memory = { 8.GB * task.attempt }
  	time = { 1.h * task.attempt }
  }

  withName: ALIGN {
	  cpus = {32 * task.attempt }
	  memory = { 24.GB * task.attempt }
  	time = { 6.h * task.attempt }
  }

  withName: ALIGN_TO_BAM {
	  cpus = {32 * task.attempt }
	  memory = { 24.GB * task.attempt }
  	time = { 6.h * task.attempt }
  }

  withName: SAMTOOLS_SORT {
	  cpus = {1 * task.attempt }
	  memory = { 1.GB * task.attempt }
  	time = { 4.h * task.attempt }
  }
  
  withName: SAMTOOLS_INDEX {
	  cpus = {1 * task.attempt }
	  memory = { 1.GB * task.attempt }
  	time = { 4.h * task.attempt }
  }

  withName: BAM_STATS_SAMTOOLS {
	  cpus = {1 * task.attempt }
	  memory = { 1.GB * task.attempt }
  	time = { 4.h * task.attempt }
  }

  withName: FLYE {
    cpus = {32 * task.attempt }
	  memory = { 96.GB * task.attempt }
  	time = { 12.h * task.attempt }
  }

  withName: QUAST {
	  cpus = {32 * task.attempt }
	  memory = { 48.GB * task.attempt }
  	time = { 12.h * task.attempt }
  }

  errorStrategy = { ( task.exitStatus == 143 || task.exitStatus == 137 ) ? 'retry' : 'finish' }
  maxRetries = 3
  maxErrors = '-1'
}

